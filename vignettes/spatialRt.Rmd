---
title: "Spatial R(t) estimation with transfer estimates"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Spatial R(t) estimation with transfer estimates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(WhiteLabRt)
```

```{r}
data("sample_multi_site")
data("transfer_matrix")
```
 
```{r} 
Y <- as.matrix(sample_multi_site[, c(2, 3)])
for(i in 1:nrow(Y)) {
  for(j in 1:ncol(Y)) {
    Y[i,j] <- as.integer(Y[i,j])
  }
}
```

```{r}
sip <- si(14, 4.29, 1.18, leading0 = FALSE)
```

```{r}
m_hier <- spatialRt(report_dates = sample_multi_site$date,
                 case_matrix = Y,
                 transfer_matrix = transfer_matrix,
                 v2 = TRUE,
                 sip = sip, chains = 1)
```
```{r}
rstan::check_divergences(m_hier)
rstan::check_hmc_diagnostics(m_hier)

out <- rstan::extract(out)
# QC
# launch_shinystan(m_hier)
```

```{r}
# -------------------------------------------------------------
# get actual data
dim(out$M)
dim(out$xsigma)

## CHANCGE THIS TO BE BY CHAIN
library(matrixStats)
data_l <- lapply(1:2, function(i) {

  data.frame(
    ##
    x      = 1:nrow(R_this),
    y_real = N[,i],
    R_back = R_this[, i], ## R_this is the backcalcualted, Rmatrix is true
    R_real = Rmatrix[, i],
    ##
    y      = colMeans(out$M[, , i]),
    yl     = colQuantiles(out$M[, , i],probs=c(0.025)),
    yh     = colQuantiles(out$M[, , i],probs=c(0.975)),
    ##
    Rt     = colMeans(out$R[ , ,i]),
    Rtl    = colQuantiles(out$R[, ,i],probs=c(0.025)),
    Rth    = colQuantiles(out$R[, ,i],probs=c(0.975)),
    #
    region = i
  )
  
})

data_all <- do.call(rbind, data_l)
head(data_all)

#data_grouped <- data_all %>% group_by(., x, region, chain)
library(tidyverse)
data_all_summarise <- data_all  %>% 
  mutate(region = paste0('region: ', region)) %>%
  group_by(x, region) %>%
  summarise(.groups = 'keep',
            y_mean = mean(y),
            y_real = mean(y_real),
            Rt_back = mean(R_back),
            Rt_real = mean(R_real),
            yl = mean(yl),
            yh = mean(yh),
            Rt_mean = mean(Rt),
            Rtl = mean(Rtl),
            Rth = mean(Rth))

### plot exepected cases
p1 <- ggplot(data_all_summarise) +
  geom_ribbon(aes(x = x,ymin=yl,ymax=yh, fill = region), alpha=0.3) + 
  geom_line(aes(y = y_mean, x = x, color = region), linewidth = 0.5) +
  geom_line(aes(y = y_real, x = x, group = region), color = 'black', linewidth = 0.25) +
  theme_classic() +  xlab("Days") + ylab('Cases') + 
  #facet_rep_wrap(~region, nrow = 3, scales = 'free_y') + 
  theme(strip.background = element_blank())

# plot R(t)
p2 <- ggplot(data_all_summarise, aes(x = x, color = region)) +
  geom_ribbon(aes(x = x,ymin=Rtl,ymax=Rth, fill = region), alpha=0.3) + 
  geom_line(aes(y=Rt_mean,x=x, color = region),linewidth = 0.5)+ 
  #geom_line(aes(y=Rt_real,x=x, group = region), color = 'black', linewidth = 0.5, linetype = '41')+
  #geom_line(aes(y=Rt_back,x=x), color = 'black', linewidth = 0.5, linetype = '11')+
  geom_hline(yintercept = 1,color = "black", linewidth = 0.25,alpha=0.5)  +
  theme_classic() +  xlab("Days") + ylab('Reproduction Number') +
  #facet_rep_wrap(~region, nrow = 3) + 
  coord_cartesian(ylim = c(0, 5)) +
  theme(strip.background = element_blank())


library(patchwork)
p1 + theme(legend.position = 'none') + 
  p2 + patchwork::plot_layout(nrow = 1)

```
